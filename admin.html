<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karam Libnan - Mobile-Friendly Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mobile-menu-btn:hover {
            background: #34495e;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 15px;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }

        .nav-item:hover, .nav-item.active {
            background: #34495e;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 15px;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }

        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }

        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .actions-cell {
            white-space: nowrap;
            width: 120px;
        }

        .actions-cell .btn {
            margin-right: 4px;
            padding: 2px 6px;
        }

        .description-cell {
            max-width: 200px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 44px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .status-message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
            font-size: 13px;
        }

        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-single {
            background: #3498db;
            color: white;
        }

        .badge-bulk {
            background: #27ae60;
            color: white;
        }

        /* Dynamic badge colors for any main category */
        .badge {
            background: #6c757d;
            color: white;
        }

        .badge[class*="badge-"] {
            background: #6c757d;
        }

        /* Tag styling */
        .tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 1px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            text-transform: capitalize;
        }

        /* Specific colors for known categories */
        .badge-single { background: #3498db !important; }
        .badge-bulk { background: #27ae60 !important; }

        .status-active {
            color: #27ae60;
        }

        .status-inactive {
            color: #e74c3c;
        }

        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* ================================
           MOBILE RESPONSIVE STYLES
           ================================ */
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 260px;
                max-width: 80vw;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 80px 10px 20px 10px;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .section {
                padding: 12px;
                margin-bottom: 15px;
                width: 100%;
                overflow-x: hidden;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                width: 100%;
            }

            .section-header h2 {
                font-size: 16px;
                word-break: break-word;
            }

            .section-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 42px;
                flex: 1;
                min-width: 80px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                width: 100%;
            }

            .stat-card {
                padding: 12px 8px;
                min-width: 0;
            }

            .stat-number {
                font-size: 18px;
            }

            .stat-label {
                font-size: 10px;
                word-break: break-word;
            }

            .table-container {
                margin-top: 15px;
                border-radius: 6px;
                border: 1px solid #eee;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 500px;
                width: 100%;
                font-size: 11px;
            }

            th, td {
                padding: 6px 4px;
                font-size: 11px;
                word-break: break-word;
                min-width: 0;
            }

            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                background: white;
                z-index: 1;
            }

            .actions-cell {
                width: 70px;
                min-width: 70px;
                white-space: nowrap;
            }

            .actions-cell .btn {
                padding: 3px 5px;
                font-size: 10px;
                margin-right: 2px;
                min-height: 28px;
                flex: none;
                min-width: 30px;
            }

            .modal {
                padding: 5px;
                align-items: flex-start;
            }

            .modal-content {
                margin: 5px;
                padding: 12px;
                max-height: calc(100vh - 10px);
                width: calc(100vw - 10px);
                max-width: calc(100vw - 10px);
                overflow-y: auto;
            }

            .modal-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .modal-header h3 {
                font-size: 14px;
                word-break: break-word;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                width: 100%;
            }

            .form-group {
                width: 100%;
                margin-bottom: 12px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-group input, 
            .form-group select, 
            .form-group textarea {
                padding: 10px;
                font-size: 16px;
                width: 100%;
                max-width: 100%;
                border-radius: 6px;
                -webkit-appearance: none;
                appearance: none;
            }

            .form-actions {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            .form-actions .btn {
                width: 100%;
                justify-content: center;
                flex: none;
            }

            .nav-item {
                padding: 15px 20px;
                font-size: 15px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                word-break: break-word;
            }

            .loading, .empty-state {
                padding: 20px 10px;
                font-size: 14px;
                word-break: break-word;
            }

            .status-message {
                margin: 8px 0;
                padding: 10px;
                font-size: 13px;
                word-break: break-word;
            }

            code {
                word-break: break-all;
                font-size: 10px;
            }

            .badge {
                font-size: 9px;
                padding: 2px 5px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 5px 15px 5px;
            }

            .section {
                padding: 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .section-actions {
                flex-direction: column;
            }

            .section-actions .btn {
                width: 100%;
                text-align: center;
                flex: none;
            }

            .actions-cell {
                width: 60px;
                min-width: 60px;
            }

            .actions-cell .btn {
                padding: 2px 3px;
                font-size: 9px;
                margin-right: 1px;
                min-width: 25px;
                min-height: 24px;
            }

            .stat-number {
                font-size: 16px;
            }

            .sidebar {
                width: 100vw;
                max-width: 100vw;
            }

            .modal-content {
                margin: 2px;
                padding: 8px;
                width: calc(100vw - 4px);
                max-width: calc(100vw - 4px);
            }

            table {
                min-width: 400px;
                font-size: 10px;
            }

            th, td {
                padding: 4px 2px;
                font-size: 10px;
            }
        }

        /* Landscape tablet */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                margin-left: 200px;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Fix for very wide tables */
        @media (max-width: 768px) {
            .table-container {
                position: relative;
            }
            
            .table-container::after {
                content: '← Scroll to see more →';
                position: absolute;
                bottom: 5px;
                right: 5px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                pointer-events: none;
                opacity: 0.8;
            }

            /* Prevent any element from breaking viewport width */
            *, *::before, *::after {
                max-width: 100vw;
                box-sizing: border-box;
            }

            /* Ensure no elements cause horizontal scroll */
            .section-header, .section, .main-content, .admin-container {
                max-width: 100vw;
                overflow-x: hidden;
            }

            /* Force word wrapping for long text */
            h1, h2, h3, h4, h5, h6, p, span, div, label {
                word-wrap: break-word;
                word-break: break-word;
                hyphens: auto;
            }

            /* Fix button text wrapping */
            .btn {
                word-wrap: break-word;
                word-break: break-word;
                white-space: normal;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <h1>Karam Libnan<br>Mobile Admin</h1>
            <button class="nav-item active" data-section="dashboard" onclick="closeMobileMenu()">📊 Dashboard</button>
            <button class="nav-item" data-section="main-categories" onclick="closeMobileMenu()">📂 Main Categories</button>
            <button class="nav-item" data-section="subcategories" onclick="closeMobileMenu()">📁 Subcategories</button>
            <button class="nav-item" data-section="products" onclick="closeMobileMenu()">🥫 Products</button>
            <button class="nav-item" data-section="sections" onclick="closeMobileMenu()">📄 Sections</button>
            <button class="nav-item" data-section="media" onclick="closeMobileMenu()">🖼️ Media</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div id="status-message" class="status-message"></div>

            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <h2>📊 Dashboard</h2>
                    <button class="btn" onclick="loadDashboard()">🔄 Refresh</button>
                </div>
                <div id="dashboard-stats" class="stats-grid">
                    <div class="loading">Loading dashboard stats...</div>
                </div>
            </section>

            <!-- Main Categories Section -->
            <section id="main-categories" class="section">
                <div class="section-header">
                    <h2>📂 Main Categories</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="showAddMainCategoryModal()">➕ Add</button>
                        <button class="btn" onclick="loadMainCategories()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="main-categories-table" class="table-container">
                    <div class="loading">Loading main categories...</div>
                </div>
            </section>

            <!-- Subcategories Section -->
            <section id="subcategories" class="section">
                <div class="section-header">
                    <h2>📁 Subcategories</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="showAddSubcategoryModal()">➕ Add</button>
                        <button class="btn" onclick="loadSubcategories()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="subcategories-table" class="table-container">
                    <div class="loading">Loading subcategories...</div>
                </div>
            </section>

            <!-- Products Section -->
            <section id="products" class="section">
                <div class="section-header">
                    <h2>🥫 Products</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="showAddProductModal()">➕ Add</button>
                        <button class="btn" onclick="loadProducts()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="products-table" class="table-container">
                    <div class="loading">Loading products...</div>
                </div>
            </section>

            <!-- Sections Section -->
            <section id="sections" class="section">
                <div class="section-header">
                    <h2>📄 Website Sections</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="showAddSectionModal()">➕ Add</button>
                        <button class="btn" onclick="loadSections()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="sections-table" class="table-container">
                    <div class="loading">Loading sections...</div>
                </div>
            </section>

            <!-- Media Section -->
            <section id="media" class="section">
                <div class="section-header">
                    <h2>🖼️ Media Files</h2>
                    <div class="section-actions">
                        <button class="btn" onclick="loadMedia()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="media-table" class="table-container">
                    <div class="loading">Loading media...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';
        
        // Mobile Navigation Functions
        window.toggleMobileMenu = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        window.closeMobileMenu = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target) && 
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        // Prevent horizontal scrolling on mobile
        document.addEventListener('touchmove', function(e) {
            if (window.innerWidth <= 768) {
                const target = e.target.closest('.table-container');
                if (!target) {
                    // Allow vertical scrolling but prevent horizontal body scroll
                    if (e.touches.length === 1) {
                        e.preventDefault;
                    }
                }
            }
        }, { passive: false });

        // Ensure viewport width is maintained
        function ensureViewportWidth() {
            if (window.innerWidth <= 768) {
                document.body.style.maxWidth = '100vw';
                document.body.style.overflowX = 'hidden';
                
                // Fix any elements that might be too wide
                const wideElements = document.querySelectorAll('table, .section, .main-content');
                wideElements.forEach(el => {
                    if (el.scrollWidth > window.innerWidth) {
                        el.style.maxWidth = '100vw';
                        el.style.overflowX = 'auto';
                    }
                });
            }
        }

        // Run on load and resize
        window.addEventListener('load', ensureViewportWidth);
        window.addEventListener('resize', ensureViewportWidth);
        window.addEventListener('orientationchange', () => {
            setTimeout(ensureViewportWidth, 100);
        });

        // Admin Panel Manager with Full CRUD + Mobile Support
        class FullCrudAdmin {
            constructor() {
                this.currentSection = 'dashboard';
                this.editingItem = null;
                this.init();
            }

            init() {
                console.log('🚀 Initializing Full CRUD Admin Panel...');
                this.setupEventListeners();
                this.testConnection();
                
                // Auto-load dashboard immediately
                this.loadDashboard();
                
                // Optional: Auto-refresh dashboard every 30 seconds
                setInterval(() => {
                    if (this.currentSection === 'dashboard') {
                        this.loadDashboard();
                    }
                }, 30000);
            }

            setupEventListeners() {
                // Navigation clicks
                document.querySelectorAll('[data-section]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.showSection(section);
                    });
                });

                // Modal close on background click
                document.getElementById('modal').addEventListener('click', (e) => {
                    if (e.target.id === 'modal') {
                        this.closeModal();
                    }
                });

                // Handle orientation change
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        if (window.innerWidth > 768) {
                            document.getElementById('sidebar').classList.remove('open');
                        }
                    }, 100);
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });
            }

            showSection(section) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Update content
                document.querySelectorAll('.section').forEach(sec => {
                    sec.classList.remove('active');
                });
                document.getElementById(section).classList.add('active');

                this.currentSection = section;
                console.log(`📄 Switched to ${section} section`);

                // Auto-load data when switching sections
                this.autoLoadSectionData(section);

                // Close mobile menu after selection
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        document.getElementById('sidebar').classList.remove('open');
                    }, 300);
                }
            }

            autoLoadSectionData(section) {
                switch (section) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'main-categories':
                        this.loadMainCategories();
                        break;
                    case 'subcategories':
                        this.loadSubcategories();
                        break;
                    case 'products':
                        this.loadProducts();
                        break;
                    case 'sections':
                        this.loadSections();
                        break;
                    case 'media':
                        this.loadMedia();
                        break;
                }
            }

            // Auto-refresh current section and dashboard after any data change
            refreshCurrentData() {
                this.loadDashboard(); // Always refresh dashboard stats
                this.autoLoadSectionData(this.currentSection); // Refresh current section
            }

            async testConnection() {
                try {
                    const { data, error } = await supabase
                        .from('products')
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        this.showMessage('❌ Connection failed: ' + error.message, 'error');
                        return false;
                    }
                    
                    this.showMessage('✅ Database connection successful', 'success');
                    return true;
                } catch (err) {
                    this.showMessage('❌ Connection error: ' + err.message, 'error');
                    return false;
                }
            }

            showMessage(message, type = 'success', duration = 4000) {
                const statusEl = document.getElementById('status-message');
                statusEl.textContent = message;
                statusEl.className = `status-message status-${type}`;
                statusEl.style.display = 'block';
                
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, duration);
            }

            openModal(title, content) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content;
                document.getElementById('modal').classList.add('show');
                
                // Prevent body scrolling when modal is open
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('modal').classList.remove('show');
                this.editingItem = null;
                
                // Re-enable body scrolling
                document.body.style.overflow = '';
            }

            // DASHBOARD
            async loadDashboard() {
                const container = document.getElementById('dashboard-stats');
                container.innerHTML = '<div class="loading">Loading stats...</div>';

                try {
                    const [productsData, subcategoriesData, mainCategoriesData, sectionsData] = await Promise.all([
                        supabase.from('products').select('id, active, featured'),
                        supabase.from('subcategories').select('slug, active'),
                        supabase.from('main_categories').select('slug, active'),
                        supabase.from('sections').select('key')
                    ]);

                    const stats = {
                        products: productsData.data?.length || 0,
                        activeProducts: productsData.data?.filter(p => p.active).length || 0,
                        featuredProducts: productsData.data?.filter(p => p.featured).length || 0,
                        subcategories: subcategoriesData.data?.length || 0,
                        mainCategories: mainCategoriesData.data?.length || 0,
                        sections: sectionsData.data?.length || 0
                    };

                    container.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.products}</div>
                            <div class="stat-label">Total Products</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.activeProducts}</div>
                            <div class="stat-label">Active Products</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.featuredProducts}</div>
                            <div class="stat-label">Featured Products</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.subcategories}</div>
                            <div class="stat-label">Subcategories</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.mainCategories}</div>
                            <div class="stat-label">Main Categories</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.sections}</div>
                            <div class="stat-label">Website Sections</div>
                        </div>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading dashboard</div>';
                    this.showMessage('Dashboard error: ' + error.message, 'error');
                }
            }

            // MAIN CATEGORIES CRUD
            async loadMainCategories() {
                const container = document.getElementById('main-categories-table');
                container.innerHTML = '<div class="loading">Loading main categories...</div>';

                try {
                    const { data, error } = await supabase
                        .from('main_categories')
                        .select('*')
                        .order('sort_order');

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No main categories found. Click "Add" to create one.</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Slug</th>
                                    <th>Title (EN)</th>
                                    <th>Title (AR)</th>
                                    <th>Description (EN)</th>
                                    <th>Description (AR)</th>
                                    <th>Sort</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(cat => `
                                    <tr>
                                        <td><code>${cat.slug}</code></td>
                                        <td>${cat.title_en || ''}</td>
                                        <td>${cat.title_ar || ''}</td>
                                        <td class="description-cell">${cat.description_en ? cat.description_en.substring(0, 50) + (cat.description_en.length > 50 ? '...' : '') : ''}</td>
                                        <td class="description-cell">${cat.description_ar ? cat.description_ar.substring(0, 50) + (cat.description_ar.length > 50 ? '...' : '') : ''}</td>
                                        <td>${cat.sort_order}</td>
                                        <td class="status-${cat.active ? 'active' : 'inactive'}">
                                            ${cat.active ? '✅ Active' : '❌ Inactive'}
                                        </td>
                                        <td>${new Date(cat.created_at).toLocaleDateString()}</td>
                                        <td class="actions-cell">
                                            <button class="btn btn-warning btn-sm" onclick="editMainCategory('${cat.slug}')">✏️</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteMainCategory('${cat.slug}')">🗑️</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading main categories</div>';
                    this.showMessage('Main categories error: ' + error.message, 'error');
                }
            }

            showAddMainCategoryModal() {
                const content = `
                    <form id="main-category-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="slug">Slug*</label>
                                <input type="text" id="slug" name="slug" required placeholder="e.g., premium">
                            </div>
                            <div class="form-group">
                                <label for="sort_order">Sort Order</label>
                                <input type="number" id="sort_order" name="sort_order" value="0">
                            </div>
                            <div class="form-group">
                                <label for="title_en">Title (English)*</label>
                                <input type="text" id="title_en" name="title_en" required placeholder="Premium Products">
                            </div>
                            <div class="form-group">
                                <label for="title_ar">Title (Arabic)</label>
                                <input type="text" id="title_ar" name="title_ar" placeholder="منتجات مميزة">
                            </div>
                            <div class="form-group">
                                <label for="description_en">Description (English)</label>
                                <textarea id="description_en" name="description_en" rows="3" placeholder="Brief description of this category..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="description_ar">Description (Arabic)</label>
                                <textarea id="description_ar" name="description_ar" rows="3" placeholder="وصف مختصر لهذه الفئة..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="active">Status</label>
                                <select id="active" name="active">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Category</button>
                        </div>
                    </form>
                `;

                this.openModal('Add Main Category', content);
                
                document.getElementById('main-category-form').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.saveMainCategory();
                };
            }

            async saveMainCategory() {
                const form = document.getElementById('main-category-form');
                const formData = new FormData(form);
                
                const data = {
                    slug: formData.get('slug'),
                    title_en: formData.get('title_en'),
                    title_ar: formData.get('title_ar') || null,
                    description_en: formData.get('description_en') || null,
                    description_ar: formData.get('description_ar') || null,
                    sort_order: parseInt(formData.get('sort_order')) || 0,
                    active: formData.get('active') === 'true'
                };

                try {
                    if (this.editingItem) {
                        const { error } = await supabase
                            .from('main_categories')
                            .update(data)
                            .eq('slug', this.editingItem);
                        
                        if (error) throw error;
                        this.showMessage('✅ Main category updated successfully!', 'success');
                    } else {
                        const { error } = await supabase
                            .from('main_categories')
                            .insert([data]);
                        
                        if (error) throw error;
                        this.showMessage('✅ Main category created successfully!', 'success');
                    }

                    this.closeModal();
                    
                    // Auto-refresh data after successful operation
                    this.loadMainCategories();
                    this.loadDashboard(); // Update dashboard stats too
                    
                } catch (error) {
                    this.showMessage('❌ Error saving main category: ' + error.message, 'error');
                }
            }

            async editMainCategory(slug) {
                try {
                    const { data, error } = await supabase
                        .from('main_categories')
                        .select('*')
                        .eq('slug', slug)
                        .single();

                    if (error) throw error;

                    this.editingItem = slug;
                    
                    const content = `
                        <form id="main-category-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="slug">Slug*</label>
                                    <input type="text" id="slug" name="slug" value="${data.slug}" required>
                                </div>
                                <div class="form-group">
                                    <label for="sort_order">Sort Order</label>
                                    <input type="number" id="sort_order" name="sort_order" value="${data.sort_order || 0}">
                                </div>
                                <div class="form-group">
                                    <label for="title_en">Title (English)*</label>
                                    <input type="text" id="title_en" name="title_en" value="${data.title_en || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="title_ar">Title (Arabic)</label>
                                    <input type="text" id="title_ar" name="title_ar" value="${data.title_ar || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="description_en">Description (English)</label>
                                    <textarea id="description_en" name="description_en" rows="3" placeholder="Brief description of this category...">${data.description_en || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="description_ar">Description (Arabic)</label>
                                    <textarea id="description_ar" name="description_ar" rows="3" placeholder="وصف مختصر لهذه الفئة...">${data.description_ar || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="active">Status</label>
                                    <select id="active" name="active">
                                        <option value="true" ${data.active ? 'selected' : ''}>Active</option>
                                        <option value="false" ${!data.active ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-warning">Update Category</button>
                            </div>
                        </form>
                    `;

                    this.openModal('Edit Main Category', content);
                    
                    document.getElementById('main-category-form').onsubmit = async (e) => {
                        e.preventDefault();
                        await this.saveMainCategory();
                    };

                } catch (error) {
                    this.showMessage('❌ Error loading main category: ' + error.message, 'error');
                }
            }

            async deleteMainCategory(slug) {
                if (!confirm(`Are you sure you want to delete the main category "${slug}"?`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('main_categories')
                        .delete()
                        .eq('slug', slug);

                    if (error) throw error;

                    this.showMessage('✅ Main category deleted successfully!', 'success');
                    this.loadMainCategories();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error deleting main category: ' + error.message, 'error');
                }
            }

            // SUBCATEGORIES CRUD
            async loadSubcategories() {
                const container = document.getElementById('subcategories-table');
                container.innerHTML = '<div class="loading">Loading subcategories...</div>';

                try {
                    const { data, error } = await supabase
                        .from('subcategories')
                        .select('*')
                        .order('category_type, sort_order');

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No subcategories found. Click "Add" to create one.</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Slug</th>
                                    <th>Main Category</th>
                                    <th>Title (EN)</th>
                                    <th>Title (AR)</th>
                                    <th>Sort</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(sub => `
                                    <tr>
                                        <td><code>${sub.slug}</code></td>
                                        <td><span class="badge badge-${sub.category_type}">${sub.category_type}</span></td>
                                        <td>${sub.title_en || ''}</td>
                                        <td>${sub.title_ar || ''}</td>
                                        <td>${sub.sort_order}</td>
                                        <td class="status-${sub.active ? 'active' : 'inactive'}">
                                            ${sub.active ? '✅' : '❌'}
                                        </td>
                                        <td class="actions-cell">
                                            <button class="btn btn-warning btn-sm" onclick="editSubcategory('${sub.slug}')">✏️</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSubcategory('${sub.slug}')">🗑️</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading subcategories</div>';
                    this.showMessage('Subcategories error: ' + error.message, 'error');
                }
            }

            async showAddSubcategoryModal() {
                // First load main categories for the dropdown
                const { data: mainCategories } = await supabase
                    .from('main_categories')
                    .select('slug, title_en')
                    .eq('active', true)
                    .order('sort_order');

                const categoryOptions = mainCategories?.map(cat => 
                    `<option value="${cat.slug}">${cat.title_en} (${cat.slug})</option>`
                ).join('') || '';

                const content = `
                    <form id="subcategory-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="slug">Slug*</label>
                                <input type="text" id="slug" name="slug" required placeholder="e.g., premium-olives">
                            </div>
                            <div class="form-group">
                                <label for="category_type">Main Category*</label>
                                <select id="category_type" name="category_type" required>
                                    <option value="">Select Main Category</option>
                                    ${categoryOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="title_en">Title (English)*</label>
                                <input type="text" id="title_en" name="title_en" required placeholder="Premium Olives">
                            </div>
                            <div class="form-group">
                                <label for="title_ar">Title (Arabic)</label>
                                <input type="text" id="title_ar" name="title_ar" placeholder="زيتون مميز">
                            </div>
                            <div class="form-group">
                                <label for="sort_order">Sort Order</label>
                                <input type="number" id="sort_order" name="sort_order" value="0">
                            </div>
                            <div class="form-group">
                                <label for="active">Status</label>
                                <select id="active" name="active">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Subcategory</button>
                        </div>
                    </form>
                `;

                this.openModal('Add Subcategory', content);
                
                document.getElementById('subcategory-form').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.saveSubcategory();
                };
            }

            async saveSubcategory() {
                const form = document.getElementById('subcategory-form');
                const formData = new FormData(form);
                
                const data = {
                    slug: formData.get('slug'),
                    category_type: formData.get('category_type'),
                    title_en: formData.get('title_en'),
                    title_ar: formData.get('title_ar') || null,
                    sort_order: parseInt(formData.get('sort_order')) || 0,
                    active: formData.get('active') === 'true'
                };

                try {
                    if (this.editingItem) {
                        const { error } = await supabase
                            .from('subcategories')
                            .update(data)
                            .eq('slug', this.editingItem);
                        
                        if (error) throw error;
                        this.showMessage('✅ Subcategory updated successfully!', 'success');
                    } else {
                        const { error } = await supabase
                            .from('subcategories')
                            .insert([data]);
                        
                        if (error) throw error;
                        this.showMessage('✅ Subcategory created successfully!', 'success');
                    }

                    this.closeModal();
                    this.loadSubcategories();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error saving subcategory: ' + error.message, 'error');
                }
            }

            async editSubcategory(slug) {
                try {
                    const [subcategoryResult, mainCategoriesResult] = await Promise.all([
                        supabase.from('subcategories').select('*').eq('slug', slug).single(),
                        supabase.from('main_categories').select('slug, title_en').eq('active', true).order('sort_order')
                    ]);

                    if (subcategoryResult.error) throw subcategoryResult.error;

                    const subcategory = subcategoryResult.data;
                    const mainCategories = mainCategoriesResult.data || [];

                    this.editingItem = slug;

                    const categoryOptions = mainCategories.map(cat => 
                        `<option value="${cat.slug}" ${subcategory.category_type === cat.slug ? 'selected' : ''}>${cat.title_en} (${cat.slug})</option>`
                    ).join('');
                    
                    const content = `
                        <form id="subcategory-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="slug">Slug*</label>
                                    <input type="text" id="slug" name="slug" value="${subcategory.slug}" required>
                                </div>
                                <div class="form-group">
                                    <label for="category_type">Main Category*</label>
                                    <select id="category_type" name="category_type" required>
                                        <option value="">Select Main Category</option>
                                        ${categoryOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="title_en">Title (English)*</label>
                                    <input type="text" id="title_en" name="title_en" value="${subcategory.title_en || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="title_ar">Title (Arabic)</label>
                                    <input type="text" id="title_ar" name="title_ar" value="${subcategory.title_ar || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="sort_order">Sort Order</label>
                                    <input type="number" id="sort_order" name="sort_order" value="${subcategory.sort_order || 0}">
                                </div>
                                <div class="form-group">
                                    <label for="active">Status</label>
                                    <select id="active" name="active">
                                        <option value="true" ${subcategory.active ? 'selected' : ''}>Active</option>
                                        <option value="false" ${!subcategory.active ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-warning">Update Subcategory</button>
                            </div>
                        </form>
                    `;

                    this.openModal('Edit Subcategory', content);
                    
                    document.getElementById('subcategory-form').onsubmit = async (e) => {
                        e.preventDefault();
                        await this.saveSubcategory();
                    };

                } catch (error) {
                    this.showMessage('❌ Error loading subcategory: ' + error.message, 'error');
                }
            }

            async deleteSubcategory(slug) {
                if (!confirm(`Are you sure you want to delete the subcategory "${slug}"?`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('subcategories')
                        .delete()
                        .eq('slug', slug);

                    if (error) throw error;

                    this.showMessage('✅ Subcategory deleted successfully!', 'success');
                    this.loadSubcategories();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error deleting subcategory: ' + error.message, 'error');
                }
            }

            // PRODUCTS CRUD
            async loadProducts() {
                const container = document.getElementById('products-table');
                container.innerHTML = '<div class="loading">Loading products...</div>';

                try {
                    const { data, error } = await supabase
                        .from('products')
                        .select('*')
                        .order('id');

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No products found. Click "Add" to create one.</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name (EN)</th>
                                    <th>Name (AR)</th>
                                    <th>Main Category</th>
                                    <th>Subcategory</th>
                                    <th>Variants</th>
                                    <th>Tags</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(product => `
                                    <tr>
                                        <td><strong>#${product.id}</strong></td>
                                        <td>${product.name_en || ''} ${product.featured ? '⭐' : ''}</td>
                                        <td>${product.name_ar || ''}</td>
                                        <td><span class="badge badge-${product.main_type}">${product.main_type}</span></td>
                                        <td><code>${product.sub_slug || '-'}</code></td>
                                        <td>${product.variants && product.variants.length > 0 ? product.variants.join(', ') : '-'}</td>
                                        <td>${product.tags && product.tags.length > 0 ? product.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ') : '-'}</td>
                                        <td class="status-${product.active ? 'active' : 'inactive'}">
                                            ${product.active ? '✅' : '❌'}
                                        </td>
                                        <td class="actions-cell">
                                            <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})">✏️</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">🗑️</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading products</div>';
                    this.showMessage('Products error: ' + error.message, 'error');
                }
            }

            async showAddProductModal() {
                // Load both subcategories and main categories for the dropdowns
                const [subcategoriesResult, mainCategoriesResult] = await Promise.all([
                    supabase.from('subcategories').select('slug, title_en, category_type').eq('active', true).order('category_type, sort_order'),
                    supabase.from('main_categories').select('slug, title_en').eq('active', true).order('sort_order')
                ]);

                const subcategoryOptions = subcategoriesResult.data?.map(sub => 
                    `<option value="${sub.slug}">${sub.title_en} [${sub.category_type}]</option>`
                ).join('') || '';

                const mainCategoryOptions = mainCategoriesResult.data?.map(cat => 
                    `<option value="${cat.slug}">${cat.title_en}</option>`
                ).join('') || '';

                const content = `
                    <form id="product-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="name_en">Name (English)*</label>
                                <input type="text" id="name_en" name="name_en" required placeholder="Premium Olive Oil">
                            </div>
                            <div class="form-group">
                                <label for="name_ar">Name (Arabic)</label>
                                <input type="text" id="name_ar" name="name_ar" placeholder="زيت زيتون مميز">
                            </div>
                            <div class="form-group">
                                <label for="main_type">Main Category*</label>
                                <select id="main_type" name="main_type" required>
                                    <option value="">Select Main Category</option>
                                    ${mainCategoryOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sub_slug">Subcategory</label>
                                <select id="sub_slug" name="sub_slug">
                                    <option value="">Select Subcategory</option>
                                    ${subcategoryOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="image_file">Product Image</label>
                                <input type="file" id="image_file" name="image_file" accept="image/*" onchange="previewImage(this)">
                                <small>Choose image file (JPEG, PNG, WebP, GIF - max 5MB)</small>
                                <img id="image_preview" style="max-width: 200px; max-height: 150px; margin-top: 10px; display: none;" alt="Preview">
                            </div>
                            <div class="form-group">
                                <label for="featured">Featured</label>
                                <select id="featured" name="featured">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="active">Status</label>
                                <select id="active" name="active">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sort_order">Sort Order</label>
                                <input type="number" id="sort_order" name="sort_order" value="999" min="1">
                                <small>Lower numbers appear first (default: 999)</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="description_en">Description (English)</label>
                            <textarea id="description_en" name="description_en" placeholder="Product description in English"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="description_ar">Description (Arabic)</label>
                            <textarea id="description_ar" name="description_ar" placeholder="وصف المنتج بالعربية"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ingredients">Ingredients (English)</label>
                            <input type="text" id="ingredients" name="ingredients" placeholder="cucumber, vinegar, salt, turmeric (separate by commas)">
                            <small>Enter ingredients separated by commas (e.g., cucumber, vinegar, salt)</small>
                        </div>
                        <div class="form-group">
                            <label for="ingredients_ar">Ingredients (Arabic)</label>
                            <input type="text" id="ingredients_ar" name="ingredients_ar" placeholder="خيار، خل، ملح، كركم (فصل بالفواصل)">
                            <small>Enter Arabic ingredients separated by commas</small>
                        </div>
                        <div class="form-group">
                            <label for="variants">Variants (English)</label>
                            <input type="text" id="variants" name="variants" placeholder="large, small, 500ml, 1L (separate by commas)">
                            <small>Enter product variants separated by commas (e.g., large, small, 500ml)</small>
                        </div>
                        <div class="form-group">
                            <label for="variants_ar">Variants (Arabic)</label>
                            <input type="text" id="variants_ar" name="variants_ar" placeholder="كبير، صغير، 500مل، 1لتر (فصل بالفواصل)">
                            <small>Enter Arabic variants separated by commas</small>
                        </div>
                        <div class="form-group">
                            <label for="tags">Special Tags (English)</label>
                            <input type="text" id="tags" name="tags" placeholder="organic, fresh, premium, halal (separate by commas)">
                            <small>Enter special tags separated by commas (e.g., organic, fresh, premium)</small>
                        </div>
                        <div class="form-group">
                            <label for="tags_ar">Special Tags (Arabic)</label>
                            <input type="text" id="tags_ar" name="tags_ar" placeholder="عضوي، طازج، مميز، حلال (فصل بالفواصل)">
                            <small>Enter Arabic special tags separated by commas</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Product</button>
                        </div>
                    </form>
                `;

                this.openModal('Add Product', content);
                
                document.getElementById('product-form').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.saveProduct();
                };
            }

            async uploadImageToStorage(file, folder = 'products') {
                try {
                    // Generate unique filename
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `${folder}/${fileName}`;
                    
                    // Upload to Supabase Storage
                    const { data, error } = await supabase.storage
                        .from('images')
                        .upload(filePath, file);
                        
                    if (error) throw error;
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('images')
                        .getPublicUrl(filePath);
                        
                    return urlData.publicUrl;
                    
                } catch (error) {
                    console.error('Image upload error:', error);
                    throw new Error(`Image upload failed: ${error.message}`);
                }
            }

            parseTags(tagsString) {
                if (!tagsString || tagsString.trim() === '') return [];
                // Split by comma, trim whitespace, filter empty strings, convert to lowercase for consistency
                return tagsString.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0)
                    .map(tag => tag.toLowerCase());
            }

            async saveProduct() {
                const form = document.getElementById('product-form');
                const formData = new FormData(form);
                
                try {
                    // Handle image upload first if file selected
                    let imageUrl = null;
                    const imageFile = formData.get('image_file');
                    if (imageFile && imageFile.size > 0) {
                        this.showMessage('📤 Uploading image...', 'info');
                        imageUrl = await this.uploadImageToStorage(imageFile);
                    }
                    
                    const data = {
                        name_en: formData.get('name_en'),
                        name_ar: formData.get('name_ar') || null,
                        description_en: formData.get('description_en') || null,
                        description_ar: formData.get('description_ar') || null,
                        main_type: formData.get('main_type'),
                        sub_slug: formData.get('sub_slug') || null,
                        ingredients: this.parseTags(formData.get('ingredients')),
                        ingredients_ar: this.parseTags(formData.get('ingredients_ar')),
                        variants: this.parseTags(formData.get('variants')),
                        variants_ar: this.parseTags(formData.get('variants_ar')),
                        featured: formData.get('featured') === 'true',
                        active: formData.get('active') === 'true',
                        tags: this.parseTags(formData.get('tags')),
                        tags_ar: this.parseTags(formData.get('tags_ar')),
                        sort_order: parseInt(formData.get('sort_order')) || 999
                    };
                    
                    // Add image URL if uploaded (for new products or when replacing existing image)
                    if (imageUrl) {
                        data.image_url = imageUrl;
                    }

                    if (this.editingItem) {
                        const { error } = await supabase
                            .from('products')
                            .update(data)
                            .eq('id', this.editingItem);
                        
                        if (error) throw error;
                        this.showMessage('✅ Product updated successfully!', 'success');
                    } else {
                        const { error } = await supabase
                            .from('products')
                            .insert([data]);
                        
                        if (error) throw error;
                        this.showMessage('✅ Product created successfully!', 'success');
                    }

                    this.closeModal();
                    this.loadProducts();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error saving product: ' + error.message, 'error');
                }
            }

            async editProduct(id) {
                try {
                    const [productResult, subcategoriesResult, mainCategoriesResult] = await Promise.all([
                        supabase.from('products').select('*').eq('id', id).single(),
                        supabase.from('subcategories').select('slug, title_en, category_type').eq('active', true).order('category_type, sort_order'),
                        supabase.from('main_categories').select('slug, title_en').eq('active', true).order('sort_order')
                    ]);

                    if (productResult.error) throw productResult.error;

                    const product = productResult.data;
                    const subcategories = subcategoriesResult.data || [];
                    const mainCategories = mainCategoriesResult.data || [];

                    this.editingItem = id;

                    const subcategoryOptions = subcategories.map(sub => 
                        `<option value="${sub.slug}" ${product.sub_slug === sub.slug ? 'selected' : ''}>${sub.title_en} (${sub.category_type})</option>`
                    ).join('');
                    
                    const mainCategoryOptions = mainCategories.map(cat => 
                        `<option value="${cat.slug}" ${product.main_type === cat.slug ? 'selected' : ''}>${cat.title_en}</option>`
                    ).join('');

                    const content = `
                        <form id="product-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="name_en">Name (English)*</label>
                                    <input type="text" id="name_en" name="name_en" value="${product.name_en || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="name_ar">Name (Arabic)</label>
                                    <input type="text" id="name_ar" name="name_ar" value="${product.name_ar || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="main_type">Main Category*</label>
                                    <select id="main_type" name="main_type" required>
                                        <option value="">Select Main Category</option>
                                        ${mainCategoryOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sub_slug">Subcategory</label>
                                    <select id="sub_slug" name="sub_slug">
                                        <option value="">Select Subcategory</option>
                                        ${subcategoryOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="image_file">Product Image</label>
                                    <input type="file" id="image_file" name="image_file" accept="image/*" onchange="previewImage(this)">
                                    <small>Choose new image file (optional - leave empty to keep current image)</small>
                                    ${product.image_url ? `<div style="margin-top: 10px;"><strong>Current image:</strong><br><img src="${product.image_url}" style="max-width: 200px; max-height: 150px;" alt="Current image"></div>` : ''}
                                    <img id="image_preview" style="max-width: 200px; max-height: 150px; margin-top: 10px; display: none;" alt="Preview">
                                </div>
                                <div class="form-group">
                                    <label for="featured">Featured</label>
                                    <select id="featured" name="featured">
                                        <option value="false" ${!product.featured ? 'selected' : ''}>No</option>
                                        <option value="true" ${product.featured ? 'selected' : ''}>Yes</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="active">Status</label>
                                    <select id="active" name="active">
                                        <option value="true" ${product.active ? 'selected' : ''}>Active</option>
                                        <option value="false" ${!product.active ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sort_order">Sort Order</label>
                                    <input type="number" id="sort_order" name="sort_order" value="${product.sort_order ?? 999}" min="1">
                                    <small>Lower numbers appear first (default: 999)</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="description_en">Description (English)</label>
                                <textarea id="description_en" name="description_en">${product.description_en || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="description_ar">Description (Arabic)</label>
                                <textarea id="description_ar" name="description_ar">${product.description_ar || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="ingredients">Ingredients (English)</label>
                                <input type="text" id="ingredients" name="ingredients" value="${product.ingredients ? (Array.isArray(product.ingredients) ? product.ingredients.join(', ') : product.ingredients) : ''}" placeholder="cucumber, vinegar, salt, turmeric (separate by commas)">
                                <small>Enter ingredients separated by commas (e.g., cucumber, vinegar, salt)</small>
                            </div>
                            <div class="form-group">
                                <label for="ingredients_ar">Ingredients (Arabic)</label>
                                <input type="text" id="ingredients_ar" name="ingredients_ar" value="${product.ingredients_ar ? (Array.isArray(product.ingredients_ar) ? product.ingredients_ar.join(', ') : product.ingredients_ar) : ''}" placeholder="خيار، خل، ملح، كركم (فصل بالفواصل)">
                                <small>Enter Arabic ingredients separated by commas</small>
                            </div>
                            <div class="form-group">
                                <label for="variants">Variants (English)</label>
                                <input type="text" id="variants" name="variants" value="${product.variants ? (Array.isArray(product.variants) ? product.variants.join(', ') : product.variants) : ''}" placeholder="large, small, 500ml, 1L (separate by commas)">
                                <small>Enter product variants separated by commas (e.g., large, small, 500ml)</small>
                            </div>
                            <div class="form-group">
                                <label for="variants_ar">Variants (Arabic)</label>
                                <input type="text" id="variants_ar" name="variants_ar" value="${product.variants_ar ? (Array.isArray(product.variants_ar) ? product.variants_ar.join(', ') : product.variants_ar) : ''}" placeholder="كبير، صغير، 500مل، 1لتر (فصل بالفواصل)">
                                <small>Enter Arabic variants separated by commas</small>
                            </div>
                            <div class="form-group">
                                <label for="tags">Special Tags (English)</label>
                                <input type="text" id="tags" name="tags" value="${product.tags ? (Array.isArray(product.tags) ? product.tags.join(', ') : product.tags) : ''}" placeholder="organic, fresh, premium, halal (separate by commas)">
                                <small>Enter special tags separated by commas (e.g., organic, fresh, premium)</small>
                            </div>
                            <div class="form-group">
                                <label for="tags_ar">Special Tags (Arabic)</label>
                                <input type="text" id="tags_ar" name="tags_ar" value="${product.tags_ar ? (Array.isArray(product.tags_ar) ? product.tags_ar.join(', ') : product.tags_ar) : ''}" placeholder="عضوي، طازج، مميز، حلال (فصل بالفواصل)">
                                <small>Enter Arabic special tags separated by commas</small>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-warning">Update Product</button>
                            </div>
                        </form>
                    `;

                    this.openModal('Edit Product', content);
                    
                    document.getElementById('product-form').onsubmit = async (e) => {
                        e.preventDefault();
                        await this.saveProduct();
                    };

                } catch (error) {
                    this.showMessage('❌ Error loading product: ' + error.message, 'error');
                }
            }

            async deleteProduct(id) {
                if (!confirm(`Are you sure you want to delete product #${id}?`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    this.showMessage('✅ Product deleted successfully!', 'success');
                    this.loadProducts();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error deleting product: ' + error.message, 'error');
                }
            }

            // SECTIONS CRUD
            async loadSections() {
                const container = document.getElementById('sections-table');
                container.innerHTML = '<div class="loading">Loading sections...</div>';

                try {
                    const { data, error } = await supabase
                        .from('sections')
                        .select('*')
                        .order('sort_order');

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No sections found. Click "Add" to create one.</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Title (EN)</th>
                                    <th>Title (AR)</th>
                                    <th>Content Preview</th>
                                    <th>Sort</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(section => `
                                    <tr>
                                        <td><code>${section.key}</code></td>
                                        <td>${section.title_en || ''}</td>
                                        <td>${section.title_ar || ''}</td>
                                        <td title="${section.content_en || ''}">
                                            ${section.content_en ? section.content_en.substring(0, 30) + '...' : '-'}
                                        </td>
                                        <td>${section.sort_order || 0}</td>
                                        <td class="actions-cell">
                                            <button class="btn btn-warning btn-sm" onclick="editSection('${section.key}')">✏️</button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteSection('${section.key}')">🗑️</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading sections</div>';
                    this.showMessage('Sections error: ' + error.message, 'error');
                }
            }

            showAddSectionModal() {
                const content = `
                    <form id="section-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="key">Key*</label>
                                <input type="text" id="key" name="key" required placeholder="e.g., about-us">
                            </div>
                            <div class="form-group">
                                <label for="sort_order">Sort Order</label>
                                <input type="number" id="sort_order" name="sort_order" value="0">
                            </div>
                            <div class="form-group">
                                <label for="title_en">Title (English)*</label>
                                <input type="text" id="title_en" name="title_en" required placeholder="About Us">
                            </div>
                            <div class="form-group">
                                <label for="title_ar">Title (Arabic)</label>
                                <input type="text" id="title_ar" name="title_ar" placeholder="عنا">
                            </div>
                            <div class="form-group">
                                <label for="image_file">Section Image</label>
                                <input type="file" id="image_file" name="image_file" accept="image/*" onchange="previewSectionImage(this)">
                                <small>Choose image file for this section</small>
                                <img id="section_image_preview" style="max-width: 200px; max-height: 150px; margin-top: 10px; display: none;" alt="Preview">
                            </div>
                            <div class="form-group">
                                <label for="image_url">Or Image URL</label>
                                <input type="url" id="image_url" name="image_url" placeholder="https://example.com/image.jpg">
                                <small>Alternative: Enter image URL directly</small>
                            </div>
                        </div>
                        
                        <!-- Hero Overlay Controls (shown only for hero section) -->
                        <div id="heroOverlayControls" style="display: none;">
                            <h3 style="margin: 20px 0 15px 0; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">🎨 Hero Overlay Controls</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="overlay_type">Overlay Type</label>
                                    <select id="overlay_type" name="overlay_type">
                                        <option value="solid">Solid Color</option>
                                        <option value="linear">Linear Gradient</option>
                                        <option value="radial">Radial Gradient</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="overlay_opacity">Overlay Intensity (%)</label>
                                    <input type="range" id="overlay_opacity" name="overlay_opacity" min="0" max="100" value="40" oninput="updateOpacityDisplay(this.value)">
                                    <small>Opacity: <span id="opacityDisplay">40%</span></small>
                                </div>
                                <div class="form-group">
                                    <label for="overlay_primary_color">Primary Color</label>
                                    <input type="color" id="overlay_primary_color" name="overlay_primary_color" value="#29241d">
                                    <small>Main overlay color</small>
                                </div>
                                <div class="form-group">
                                    <label for="overlay_secondary_color">Secondary Color</label>
                                    <input type="color" id="overlay_secondary_color" name="overlay_secondary_color" value="#29241d">
                                    <small>For gradient overlays</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="content_en">Content (English)</label>
                            <textarea id="content_en" name="content_en" placeholder="Brief description/intro text"></textarea>
                            <small>Short description for the section</small>
                        </div>
                        <div class="form-group">
                            <label for="content_ar">Content (Arabic)</label>
                            <textarea id="content_ar" name="content_ar" placeholder="وصف مختصر للقسم"></textarea>
                            <small>Short description in Arabic</small>
                        </div>
                        <div class="form-group">
                            <label for="body_en">Full Body Content (English)</label>
                            <textarea id="body_en" name="body_en" rows="8" placeholder="Full HTML content for the section (paragraphs, lists, etc.)"></textarea>
                            <small>Full HTML content - you can use &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, etc.</small>
                        </div>
                        <div class="form-group">
                            <label for="body_ar">Full Body Content (Arabic)</label>
                            <textarea id="body_ar" name="body_ar" rows="8" placeholder="المحتوى الكامل بالعربية"></textarea>
                            <small>Full HTML content in Arabic</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Section</button>
                        </div>
                    </form>
                `;

                this.openModal('Add Section', content);
                
                document.getElementById('section-form').onsubmit = async (e) => {
                    e.preventDefault();
                    await this.saveSection();
                };
                
                // Add event listener to key input to show/hide overlay controls
                document.getElementById('key').addEventListener('input', (e) => {
                    toggleHeroOverlayControls(e.target.value);
                });
            }

            async saveSection() {
                const form = document.getElementById('section-form');
                const formData = new FormData(form);
                
                try {
                    // Handle image upload first if file selected
                    let imageUrl = formData.get('image_url') || null; // Keep existing URL as fallback
                    const imageFile = formData.get('image_file');
                    if (imageFile && imageFile.size > 0) {
                        this.showMessage('📤 Uploading section image...', 'info');
                        imageUrl = await this.uploadImageToStorage(imageFile, 'sections');
                    }
                    
                    const data = {
                        key: formData.get('key'),
                        title_en: formData.get('title_en'),
                        title_ar: formData.get('title_ar') || null,
                        content_en: formData.get('content_en') || null,
                        content_ar: formData.get('content_ar') || null,
                        body_en: formData.get('body_en') || null,
                        body_ar: formData.get('body_ar') || null,
                        image_url: imageUrl,
                        sort_order: parseInt(formData.get('sort_order')) || 0
                    };
                    
                    // Add overlay controls for hero section
                    if (formData.get('key') === 'hero' || this.editingItem === 'hero') {
                        data.overlay_type = formData.get('overlay_type') || 'linear';
                        data.overlay_opacity = parseInt(formData.get('overlay_opacity')) || 40;
                        data.overlay_primary_color = formData.get('overlay_primary_color') || '#29241d';
                        data.overlay_secondary_color = formData.get('overlay_secondary_color') || '#29241d';
                    }

                    if (this.editingItem) {
                        const { error } = await supabase
                            .from('sections')
                            .update(data)
                            .eq('key', this.editingItem);
                        
                        if (error) throw error;
                        this.showMessage('✅ Section updated successfully!', 'success');
                    } else {
                        const { error } = await supabase
                            .from('sections')
                            .insert([data]);
                        
                        if (error) throw error;
                        this.showMessage('✅ Section created successfully!', 'success');
                    }

                    this.closeModal();
                    this.loadSections();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error saving section: ' + error.message, 'error');
                }
            }

            async editSection(key) {
                try {
                    const { data, error } = await supabase
                        .from('sections')
                        .select('*')
                        .eq('key', key)
                        .single();

                    if (error) throw error;

                    this.editingItem = key;
                    
                    const content = `
                        <form id="section-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="key">Key*</label>
                                    <input type="text" id="key" name="key" value="${data.key}" required>
                                </div>
                                <div class="form-group">
                                    <label for="sort_order">Sort Order</label>
                                    <input type="number" id="sort_order" name="sort_order" value="${data.sort_order || 0}">
                                </div>
                                <div class="form-group">
                                    <label for="title_en">Title (English)*</label>
                                    <input type="text" id="title_en" name="title_en" value="${data.title_en || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="title_ar">Title (Arabic)</label>
                                    <input type="text" id="title_ar" name="title_ar" value="${data.title_ar || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="image_file">Section Image</label>
                                    <input type="file" id="image_file" name="image_file" accept="image/*" onchange="previewSectionImage(this)">
                                    <small>Choose new image file (optional - leave empty to keep current image)</small>
                                    ${data.image_url ? `<div style="margin-top: 10px;"><strong>Current image:</strong><br><img src="${data.image_url}" style="max-width: 200px; max-height: 150px;" alt="Current image"></div>` : ''}
                                    <img id="section_image_preview" style="max-width: 200px; max-height: 150px; margin-top: 10px; display: none;" alt="Preview">
                                </div>
                                <div class="form-group">
                                    <label for="image_url">Or Image URL</label>
                                    <input type="url" id="image_url" name="image_url" value="${data.image_url || ''}">
                                    <small>Alternative: Enter image URL directly</small>
                                </div>
                            </div>
                            
                            <!-- Hero Overlay Controls (shown only for hero section) -->
                            <div id="heroOverlayControlsEdit" style="display: ${data.key === 'hero' ? 'block' : 'none'};">
                                <h3 style="margin: 20px 0 15px 0; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">🎨 Hero Overlay Controls</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="overlay_type">Overlay Type</label>
                                        <select id="overlay_type" name="overlay_type">
                                            <option value="solid" ${data.overlay_type === 'solid' ? 'selected' : ''}>Solid Color</option>
                                            <option value="linear" ${data.overlay_type === 'linear' || !data.overlay_type ? 'selected' : ''}>Linear Gradient</option>
                                            <option value="radial" ${data.overlay_type === 'radial' ? 'selected' : ''}>Radial Gradient</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="overlay_opacity">Overlay Intensity (%)</label>
                                        <input type="range" id="overlay_opacity" name="overlay_opacity" min="0" max="100" value="${data.overlay_opacity || 40}" oninput="updateOpacityDisplay(this.value)">
                                        <small>Opacity: <span id="opacityDisplay">${data.overlay_opacity || 40}%</span></small>
                                    </div>
                                    <div class="form-group">
                                        <label for="overlay_primary_color">Primary Color</label>
                                        <input type="color" id="overlay_primary_color" name="overlay_primary_color" value="${data.overlay_primary_color || '#29241d'}">
                                        <small>Main overlay color</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="overlay_secondary_color">Secondary Color</label>
                                        <input type="color" id="overlay_secondary_color" name="overlay_secondary_color" value="${data.overlay_secondary_color || '#29241d'}">
                                        <small>For gradient overlays</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="content_en">Content (English)</label>
                                <textarea id="content_en" name="content_en">${data.content_en || ''}</textarea>
                                <small>Short description for the section</small>
                            </div>
                            <div class="form-group">
                                <label for="content_ar">Content (Arabic)</label>
                                <textarea id="content_ar" name="content_ar">${data.content_ar || ''}</textarea>
                                <small>Short description in Arabic</small>
                            </div>
                            <div class="form-group">
                                <label for="body_en">Full Body Content (English)</label>
                                <textarea id="body_en" name="body_en" rows="8">${data.body_en || ''}</textarea>
                                <small>Full HTML content - you can use &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, etc.</small>
                            </div>
                            <div class="form-group">
                                <label for="body_ar">Full Body Content (Arabic)</label>
                                <textarea id="body_ar" name="body_ar" rows="8">${data.body_ar || ''}</textarea>
                                <small>Full HTML content in Arabic</small>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-warning">Update Section</button>
                            </div>
                        </form>
                    `;

                    this.openModal('Edit Section', content);
                    
                    document.getElementById('section-form').onsubmit = async (e) => {
                        e.preventDefault();
                        await this.saveSection();
                    };

                } catch (error) {
                    this.showMessage('❌ Error loading section: ' + error.message, 'error');
                }
            }

            async deleteSection(key) {
                if (!confirm(`Are you sure you want to delete the section "${key}"?`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('sections')
                        .delete()
                        .eq('key', key);

                    if (error) throw error;

                    this.showMessage('✅ Section deleted successfully!', 'success');
                    this.loadSections();
                    this.loadDashboard();
                } catch (error) {
                    this.showMessage('❌ Error deleting section: ' + error.message, 'error');
                }
            }

            // MEDIA (read only for now)
            async loadMedia() {
                const container = document.getElementById('media-table');
                container.innerHTML = '<div class="loading">Loading media files...</div>';

                try {
                    const { data, error } = await supabase
                        .from('media')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No media files found</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>File Name</th>
                                    <th>Path</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Uploaded</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(media => `
                                    <tr>
                                        <td><code>${media.id.substring(0, 8)}...</code></td>
                                        <td>${media.file_name || '-'}</td>
                                        <td><code>${media.file_path || '-'}</code></td>
                                        <td>${media.file_size ? (media.file_size / 1024).toFixed(1) + ' KB' : '-'}</td>
                                        <td><span class="badge">${media.mime_type || '-'}</span></td>
                                        <td>${new Date(media.created_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                } catch (error) {
                    container.innerHTML = '<div class="empty-state">Error loading media</div>';
                    this.showMessage('Media error: ' + error.message, 'error');
                }
            }
        }

        // Image preview function
        function previewImage(input) {
            const preview = document.getElementById('image_preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Section image preview function
        function previewSectionImage(input) {
            const preview = document.getElementById('section_image_preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Update opacity display
        function updateOpacityDisplay(value) {
            const display = document.getElementById('opacityDisplay');
            if (display) {
                display.textContent = value + '%';
            }
        }

        // Show/hide hero overlay controls based on section key
        function toggleHeroOverlayControls(key) {
            const controls = document.getElementById('heroOverlayControls');
            const controlsEdit = document.getElementById('heroOverlayControlsEdit');
            
            if (controls) {
                controls.style.display = key === 'hero' ? 'block' : 'none';
            }
            if (controlsEdit) {
                controlsEdit.style.display = key === 'hero' ? 'block' : 'none';
            }
        }

        // Global functions for button clicks
        window.loadDashboard = () => admin.loadDashboard();
        window.loadMainCategories = () => admin.loadMainCategories();
        window.loadSubcategories = () => admin.loadSubcategories();
        window.loadProducts = () => admin.loadProducts();
        window.loadSections = () => admin.loadSections();
        window.loadMedia = () => admin.loadMedia();
        window.closeModal = () => admin.closeModal();
        window.previewSectionImage = previewSectionImage;
        window.updateOpacityDisplay = updateOpacityDisplay;
        window.toggleHeroOverlayControls = toggleHeroOverlayControls;

        // Main Categories CRUD
        window.showAddMainCategoryModal = () => admin.showAddMainCategoryModal();
        window.editMainCategory = (slug) => admin.editMainCategory(slug);
        window.deleteMainCategory = (slug) => admin.deleteMainCategory(slug);

        // Subcategories CRUD  
        window.showAddSubcategoryModal = () => admin.showAddSubcategoryModal();
        window.editSubcategory = (slug) => admin.editSubcategory(slug);
        window.deleteSubcategory = (slug) => admin.deleteSubcategory(slug);

        // Products CRUD
        window.showAddProductModal = () => admin.showAddProductModal();
        window.editProduct = (id) => admin.editProduct(id);
        window.deleteProduct = (id) => admin.deleteProduct(id);

        // Sections CRUD
        window.showAddSectionModal = () => admin.showAddSectionModal();
        window.editSection = (key) => admin.editSection(key);
        window.deleteSection = (key) => admin.deleteSection(key);

        // Initialize admin panel
        const admin = new FullCrudAdmin();
        
        console.log('✅ Full CRUD Admin Panel Ready!');
    </script>
</body>
</html>
